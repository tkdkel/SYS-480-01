function 480Banner() {
    $banner = "
    ⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡖⠲⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⠀⠀⠀⠀⡟⠀⠀⠈⢦⠀⠀⠀⠀⠀⡾⠋⠱⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⢸⡋⠛⠻⠃⠀⠀⠀⠸⠷⠦⠤⠤⠿⠷⣶⣶⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⡾⠛⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠻⢶⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⠙⣦⣄⠀⠷⢶⣤⣀⠀⠀⠀⠀⠀⠀⢀⡴⠶⠦⠤⣄⠀⠙⠒⢤⣄⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⠀⠀⠙⠧⣄⠀⠀⠀⠉⠐⠦⣤⣀⢠⡟⢠⣶⣶⡄⢘⡆⠀⠀⠀⠉⠛⢦⣠⣖⡲⡄⠀
    ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠳⣦⡄⠀⠀⠀⠀⠉⠛⠿⣆⣉⣉⣁⣤⠗⠀⠀⠀⠀⠀⠀⠉⠻⣿⢇⡇
    ⠀⣠⠶⣿⣿⡶⠿⠛⢻⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠛⠻⠤⣀⡀⠀⠀⢠⡄⠀⠀⠀⠘⣿⠀
    ⢸⣧⢴⠻⡏⠀⠀⠀⣸⠀⠀⡏⠀⠀⠀⠀⠀⠀⠀⠀⠈⣷⠦⣄⡀⠀⠈⠑⠲⠤⣤⣄⣀⣀⣠⠟⠀
    ⠀⢹⠿⠒⢷⠀⠀⠀⢿⠀⢸⠃⠀⠀⠀⠀⠀⠀⠀⠀⢰⣿⠀⣼⡿⠻⠶⢤⣤⣀⣀⡬⠟⠁⠀⠀⠀
    ⠀⠸⣤⣖⣿⢇⠀⠀⠘⢷⣼⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⢠⡟⠀⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠈⠉⡿⠹⣷⣄⠀⠈⠻⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣷⡿⠀⠀⢀⣾⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⢠⠃⠀⡟⠉⠙⢶⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣟⣀⣤⡶⠚⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⡸⠀⢀⡇⠀⠀⢠⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⡟⠛⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⢀⡇⠀⢸⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⢠⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⣸⠃⠀⢸⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⢠⣿⠀⠀⡇⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⢸⡇⠀⠀⣷⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⣿⠃⠀⠀⢿⠀⠀⢰⠃⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⣿⠀⠀⠀⠈⢧⡀⣼⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⢿⡀⠀⠀⠀⠈⢷⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠈⣧⠀⠀⠀⠀⢸⡏⠀⠀⠀⠀⠀⠀⠀⠀⢸⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠘⡄⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⢹⡀⠀⢰⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⢳⣤⣯⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠈⢷⣯⡏⠀⠀⠀⠀⠀⠀⠀⠀⢀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⠘⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⠀⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⣼⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⣰⠟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢷⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⢰⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⢀⡟⠀⠀⠀⠀⠀⠀⢰⡿⠛⢇⠀⠀⠀⠀⢸⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⣸⠃⠀⠀⠀⠀⠀⢠⡿⠀⠀⢸⠀⠀⠀⢀⣾⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⣾⠀⠀⠀⠈⠉⠉⠉⠉⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠙⠒⠒⠒⠒⠒⠚⠀⠀⠀⠀⠀⠀
    ╰•★★ I spent way too long on this -kel ★★•╯⠀⠀
    "
    Write-Host $banner 
}

function Connect-480([string] $server){
    #are we already connected?
    if ($global:DefaultVIServer){
        Write-Host -ForegroundColor Cyan "Already connected to $($global:DefaultVIServer.Name)"
        return
    }
    else {
        #connect to the server
        Connect-VIServer -Server $server
        Write-Host -ForegroundColor Green "Connected to $server"
    }
}

function Disconnect-480(){
    #Checks for connection - if connected, disconnects
    if ($global:DefaultVIServer){
        Disconnect-VIServer -Server $global:DefaultVIServer -Confirm:$false
        Write-Host -ForegroundColor Green "Disconnected from vcenter.kel.local"
    }
}

function Get-480Config([string] $config_path){
    $conf = $null
    if(test-path $config_path){
        $conf= Get-Content -Raw -Path $config_path | ConvertFrom-Json
        $msg = "Configuration file loaded from $config_path"
        Write-Host -ForegroundColor Green $msg
    }
    else {
        $msg = "Configuration file not found at $config_path"
        Write-Host -ForegroundColor Red $msg
    }
    return $conf
}

function Select-Folder(){
    try{
        $folder = $null
        $folders = Get-Folder | Where-Object { $_.Name -in @("BASEVM", "PROD") }
        $index = 1
        Write-Host ""
        Write-Host "Select a Folder" 
        foreach ($folder in $folders){
            Write-Host -ForegroundColor DarkCyan [$index] $folder.Name
            $index++
        }
        Write-Host ""
        $selection = Read-Host "Select a Folder by number"
        $folder = $folders[$selection-1]
        Write-Host ""
        Write-Host -ForegroundColor Green "Selected Folder: $($folder.Name)"
        return $folder
    }
    catch{
        Write-Host -ForegroundColor Red "Error selecting Folder"
        return $null
    }
}

function Select-VM(){
    try{
        $vm=$null
        $vms = Get-VM -Location $folder
        $index = 1
        Write-Host ""
        Write-Host "Select a VM" 
        foreach ($vm in $vms){
            Write-Host -ForegroundColor Cyan [$index] $vm.Name 
            if ($vm.PowerState -eq "PoweredOn") {
                Write-Host -ForegroundColor Green "Powered On"
                }   
            else {
                Write-Host -ForegroundColor Red "Powered Off"
                }

            Write-Host ""
            $index++
            }
        Write-Host ""
        $selection = Read-Host "Select a VM by number"
        $vm = $vms[$selection-1]
        Write-Host ""
        Write-Host -ForegroundColor Green "Selected VM: $($vm.Name)"
        return $vm
        }
    catch{
        Write-Host -ForegroundColor Red "Error selecting VM"
        return $null
    }
}

function Terminate-VM(){
    $folder = Select-Folder
    if ($folder -eq "PROD"){
        Write-Host -ForegroundColor Red "You cannot delete VMs from the PROD folder"
        exit
    }
    else{
        $vm = Select-VM
        if($vm.PowerState -eq "PoweredOn"){
            write-host -ForegroundColor Red "VM $($vm.Name) is powered on"
            $ans = Read-Host "Would you like to power off the VM? (y/n)"
            if($ans -eq "y" -or $ans -eq "yes"){
                Stop-VM -VM $vm -Confirm:$false
                Write-Host -ForegroundColor Green "VM $($vm.Name) powered off"
            }
            else{
                Write-Host -ForegroundColor Red "VM $($vm.Name) not powered off"
            }
        }
        $confirmation = Read-Host "Are you sure you want to delete $($vm.Name)? (yes/no)"
        if ($confirmation -eq "yes" -or $confirmation -eq "y"){
            Remove-VM -VM $vm -DeleteFromDisk -Confirm:$false
            Write-Host -ForegroundColor Green "VM $($vm.Name) deleted"
        }
        else{
            Write-Host -ForegroundColor Red "VM $($vm.Name) not deleted"
        }
    }
}

function CreateClone(){
    Write-Host -ForegroundColor Cyan "Clone Type:"
    Write-Host -ForegroundColor DarkCyan "1 - Full Clone"
    Write-Host -ForegroundColor DarkCyan "2 - Linked Clone"
    $clone_type= Read-Host "Select a Clone Type by number"
    if ($clone_type -eq "1"){
        $clone_name = Read-Host "Enter the name of the new clone"
        $folder=Select-Folder
        $vm=Select-VM
        $ds=Select-Datastore
        if ($clone_type -eq "1"){
            New-VM -Name $clone_name -VM $vm -Datastore $ds -VMHost "192.168.7.36" -Location $folder -RunAsync
            Write-Host -ForegroundColor Green "Full Clone created: $clone_name"
        }
    }
    elseif ($clone_type -eq "2"){
        $clone_name = Read-Host "Enter the name of the new clone"
        $folder=Select-Folder
        $vm=Select-VM
        $ds=Select-Datastore
        $snap=Select-Snapshot
        New-VM -Name $clone_name -VM $vm -Datastore $ds -VMHost "192.168.7.36" -Location $folder -LinkedClone -ReferenceSnapshot $snap
    }
    else{
        continue
    }
}


function Select-Datastore(){
    try{
        $ds=$null
        $ds = Get-Datastore | Sort-Object Name
        $index = 1
        Write-Host ""
        Write-Host "Select a Datastore" 
        foreach ($d in $ds){
            $free = [math]::Round($d.FreeSpaceGB, 2)
            Write-Host -ForegroundColor Cyan [$index] $($d.Name) " -- Free Space: $free GB"
            $index++
            }
            Write-Host ""
        $selection = Read-Host "Select a Datastore by number"
        $ds = $ds[$selection-1]
        Write-Host ""
        Write-Host -ForegroundColor Green "Selected Datastore: $($ds.Name)"
        return $ds
        }
    catch{
        Write-Host -ForegroundColor Red "Error selecting Datastore"
        return $null
    }
}

function Select-Snapshot(){
    try{
        $snap=$null
        $snap = Get-Snapshot -VM $vm
        $snap = $snap | Sort-Object Created
        $index = 1
        Write-Host ""
        Write-Host "Select a Snapshot" 
        foreach ($s in $snap){
            Write-Host -ForegroundColor DarkCyan [$index] $s.Name " -- Created: $($s.Created)"
            $index++
            }
        Write-Host ""
        $selection = Read-Host "Select a Snapshot by number"
        $snap = $snap[$selection-1]
        Write-Host ""
        Write-Host -ForegroundColor Green "Selected Snapshot: $($snap.Name)"
        return $snap
        }
            catch{
                Write-Host -ForegroundColor Red "Error selecting Snapshot"
                return $null
            }
        }

function Get-IP() {
    try {
        $selectedVM = Select-VM
        if (-not $selectedVM) {
            Write-Host -ForegroundColor Red "No VM selected."
            return
        }

        $vmGuestDetails = Get-VMGuest -VM $selectedVM
        if (-not $vmGuestDetails) {
            Write-Host -ForegroundColor Red "Failed to retrieve details for the selected VM."
            return
        }

        $vmNetworkAdapters = Get-NetworkAdapter -VM $selectedVM
        if (-not $vmNetworkAdapters) {
            Write-Host -ForegroundColor Red "No network adapters found for the selected VM."
            return
        }

        $index = 0
        foreach ($adapter in $vmNetworkAdapters) {
            $adapterName = $adapter.Name
            $vmIP = $vmGuestDetails.IPAddress[$index] | Where-Object { $_ -match '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}' }
            $vmMAC = $adapter.MACAddress
            $vmSubnetMask = "255.255.255.0"

            Write-Host -ForegroundColor Green "Network Information for Adapter: $($adapterName)"
            Write-Host -ForegroundColor DarkGreen "Hostname: $($vmGuestDetails.Hostname)"
            Write-Host -ForegroundColor DarkGreen "IP Address: $vmIP"
            Write-Host -ForegroundColor DarkGreen "MAC Address: $vmMAC"
            Write-Host -ForegroundColor DarkGreen "Subnet Mask: $vmSubnetMask"
            
            $index += 2
        }
    } catch {
        Write-Host -ForegroundColor Red "An unexpected error occurred: $_"
    }
}

function New-Network(){
# Creates a new virtual switch
    $vmHost = (Get-VMHost).Name
    try {
        # Attempting to create a new virtual switch
        $switchName = Read-Host "Enter the name of the new vSwitch: "
        New-VirtualSwitch -VMHost $vmHost -Name $switchName -ErrorAction Stop
        Write-Host -ForegroundColor Green "New vSwitch ($switchName) created on $vmHost"
    } catch {
        Write-Host -ForegroundColor Red "Failed to create vSwitch ($switchName) on $vmHost"
    }

    try {
        # Attempting to create a new port group
        $portGroupName = Read-Host "Enter the name of the new port group: "
        New-VirtualPortGroup -VirtualSwitch $switchName -Name $portGroupName -ErrorAction Stop
        Write-Host -ForegroundColor Green "New port group ($portGroupName) created on $vmHost"
    } catch {
        Write-Host -ForegroundColor Red "Failed to create port group ($portGroupName) on $vmHost"
    }
}

function Set-VMpower() {
    try {
        $selectedVM = Select-VM
        if (-not $selectedVM) {
            Write-Host -ForegroundColor Red "No VM selected."
            return
        }

        if ($selectedVM.PowerState -eq "PoweredOn") {
            Write-Host -ForegroundColor Green "$($selectedVM.Name) - Powered On"
        } else {
            Write-Host -ForegroundColor Red "$($selectedVM.Name) - Powered Off"
        }

        Write-Host -ForegroundColor DarkGreen "1 - Power On"
        Write-Host -ForegroundColor DarkRed "2 - Power Off"
        $userChoice = Read-Host "Select what you would like to do with the VM."
        
        switch ($userChoice) {
            "1" {
                Start-VM -VM $selectedVM -Confirm:$false
                Write-Host -ForegroundColor Green "VM $($selectedVM.Name) powered on"
            }
            "2" {
                Stop-VM -VM $selectedVM -Confirm:$false
                Write-Host -ForegroundColor Green "VM $($selectedVM.Name) powered off"
            }
            default {
                Write-Host -ForegroundColor Yellow "Invalid selection."
            }
        }
    } catch {
        Write-Host -ForegroundColor Red "Error changing the power state of the VM."
    }
}

function Set-Network {
    try {
        $selectedVM = Select-VM
        if (-not $selectedVM) {
            Write-Host -ForegroundColor Red "No VM selected."
            return
        }

        $vmNetworkAdapters = Get-NetworkAdapter -VM $selectedVM
        if ($vmNetworkAdapters.Count -eq 0) {
            Write-Host -ForegroundColor Red "No network adapters found."
            return
        }

        Write-Host -ForegroundColor Cyan "Select the network adapter(s) you want to configure by index:"
        for ($i = 0; $i -lt $vmNetworkAdapters.Count; $i++) {
            Write-Host -ForegroundColor Cyan "[$($i + 1)] $($vmNetworkAdapters[$i].Name)"
        }

        $adapterSelections = Read-Host "Enter the adapter numbers separated by comma (e.g., 1,3)"
        $selectedAdapters = $adapterSelections.Split(',') | ForEach-Object { $vmNetworkAdapters[$_ - 1] }

        Write-Host -ForegroundColor Cyan "Listing all networks:"
        $allNetworks = Get-VirtualNetwork
        for ($i = 0; $i -lt $allNetworks.Count; $i++) {
            Write-Host -ForegroundColor Cyan "[$($i + 1)] $($allNetworks[$i].Name)"
        }

        $networkSelection = Read-Host "Enter the number of the new network for the selected adapter(s)"
        $selectedNetworkName = $allNetworks[$networkSelection - 1].Name

        if ($selectedNetworkName) {
            foreach ($adapter in $selectedAdapters) {
                Set-NetworkAdapter -NetworkAdapter $adapter -NetworkName $selectedNetworkName -Confirm:$false
                Write-Host -ForegroundColor Green "Network adapter $($adapter.Name) of VM $($selectedVM.Name) changed to $selectedNetworkName"
            }
        } else {
            Write-Host -ForegroundColor Red "Invalid network selection."
        }
    } catch {
        Write-Host -ForegroundColor Red "An error occurred while changing the network: $_"
    }
}

function Set-WinIP {
    try{
        $vm = Select-VM
        $passwd = Read-Host "Enter the password for your deployer account:" -AsSecureString
        $ip = Read-Host "Enter the IP for the new VM:"
        $subnet = Read-Host "Enter the subnet (ex. 255.255.255.0):"
        $dns = Read-Host "Enter the IP for the DNS server:"
        $gateway = Read-Host "Enter the gateway IP:"
    } catch {
        Write-Host -ForegroundColor Red "An error has occured."
    }

    $staticIP = "netsh interface ipv4 set address Ethernet0 static $ip $subnet $gateway"
    $setDNS = "netsh interface ipv4 add dnsserver Ethernet0 address=$dns index=1"

    Invoke-VMScript -ScriptText $staticIP -VM $vm -GuestUser Administrator -GuestPassword $passwd
    Invoke-VMScript -ScriptText $setDNS -VM $vm -GuestUser Administrator -GuestPassword $passwd
}
